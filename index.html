<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PET æ™ºæ…§æ’ç¨‹åŠ©æ‰‹</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --pink-50: #fdf2f8;
            --pink-100: #fce7f3;
            --pink-200: #fbcfe8;
            --pink-300: #f9a8d4;
            --pink-400: #f472b6;
            --pink-500: #ec4899;
            --rose-50: #fff1f2;
            --rose-100: #ffe4e6;
            --lavender-50: #faf5ff;
            --lavender-100: #f3e8ff;
            --lavender-200: #e9d5ff;
            --mint-50: #f0fdf4;
            --mint-100: #dcfce7;
            --mint-200: #bbf7d0;
            --peach-50: #fff7ed;
            --peach-100: #ffedd5;
            --cream: #fffbf7;
            --warm-gray-50: #fafaf9;
            --warm-gray-100: #f5f5f4;
            --warm-gray-200: #e7e5e4;
            --warm-gray-600: #78716c;
            --warm-gray-700: #57534e;
            --warm-gray-800: #44403c;
        }

        * {
            font-family: 'Nunito', 'Segoe UI', system-ui, sans-serif;
            box-sizing: border-box;
        }

        body {
            margin: 0;
            background: linear-gradient(135deg, var(--pink-50) 0%, var(--lavender-50) 50%, var(--mint-50) 100%);
            min-height: 100vh;
        }

        /* å‘¼å¸ç‡ˆå‹•ç•« */
        @keyframes pulse-soft {

            0%,
            100% {
                opacity: 1;
                box-shadow: 0 0 0 0 rgba(251, 146, 60, 0.3);
            }

            50% {
                opacity: 0.85;
                box-shadow: 0 0 12px 4px rgba(251, 146, 60, 0.2);
            }
        }

        .pulse-delayed {
            animation: pulse-soft 2.5s ease-in-out infinite;
        }

        /* åˆ—å°å„ªåŒ– - åªå° æ‰“è—¥æ™‚åˆ»è¡¨ å’Œ åŸ·è¡Œæ¸…å–® */
        @media print {
            body * {
                visibility: hidden;
            }

            .printable-section,
            .printable-section * {
                visibility: visible !important;
            }

            .printable-section {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin-bottom: 24px;
                page-break-inside: avoid;
            }

            .printable-section:nth-of-type(2) {
                position: relative;
                margin-top: 24px;
            }

            .no-print {
                display: none !important;
            }

            .print-only {
                display: block !important;
            }

            body {
                background: white !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            .card {
                box-shadow: none !important;
                border: 1px solid #e5e7eb !important;
            }
        }

        .print-only {
            display: none;
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .card {
                border-radius: 12px !important;
            }

            table {
                font-size: 12px !important;
            }

            th,
            td {
                padding: 10px 8px !important;
            }

            /* æ‰‹æ©Ÿè¼¸å…¥å„ªåŒ– */
            .input-soft {
                font-size: 16px !important;
                /* é˜²æ­¢ iOS æ”¾å¤§ */
                padding: 12px 16px !important;
                min-height: 48px;
            }

            .config-grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 12px !important;
            }

            .patient-input {
                font-size: 36px !important;
            }
        }

        @media (max-width: 480px) {
            table {
                font-size: 11px !important;
            }

            th,
            td {
                padding: 8px 6px !important;
            }

            .config-grid {
                grid-template-columns: 1fr !important;
            }

            .tab-btn {
                padding: 10px 16px !important;
                font-size: 13px !important;
            }

            /* å„ªåŒ–å»ºè­°åœ¨æ‰‹æ©Ÿä¸Šå‚ç›´æ’åˆ— */
            .optimization-card {
                flex-direction: column !important;
                align-items: flex-start !important;
            }

            /* æ™‚é–“è¼¸å…¥æ¡†åœ¨æ‰‹æ©Ÿä¸Šæ›´å¯¬ */
            input[type="time"] {
                width: 100% !important;
                min-width: 140px !important;
            }
        }

        /* FA Icon æ¨£å¼ */
        .icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        /* æŒ‰éˆ• hover æ•ˆæœ */
        .btn-soft {
            transition: all 0.2s ease;
        }

        .btn-soft:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .btn-soft:active {
            transform: translateY(0);
        }

        /* å¡ç‰‡ */
        .card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.04);
            border: 1px solid rgba(0, 0, 0, 0.04);
        }

        /* è¡¨æ ¼è¡Œ hover */
        .table-row:hover {
            background: var(--pink-50);
        }

        /* è¼¸å…¥æ¡† */
        .input-soft {
            border: 2px solid var(--warm-gray-200);
            border-radius: 12px;
            padding: 10px 16px;
            font-size: 15px;
            transition: all 0.2s ease;
            outline: none;
        }

        .input-soft:focus {
            border-color: var(--pink-300);
            box-shadow: 0 0 0 3px rgba(249, 168, 212, 0.2);
        }

        /* éš±è— number input çš„ spinner arrows */
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type="number"] {
            -moz-appearance: textfield;
            appearance: textfield;
        }

        /* ç—…äººæ•¸é‡è¼¸å…¥æ¡† */
        .patient-count-input {
            width: 80px !important;
            min-width: 80px;
            text-align: center;
            font-size: 24px !important;
            font-weight: 700;
            padding: 8px 12px !important;
        }

        /* ç”˜ç‰¹åœ–æ¢ */
        .gantt-bar {
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .gantt-bar:hover {
            filter: brightness(1.05);
            transform: scaleY(1.15);
        }

        /* åˆ‡æ–·é»æ¨£å¼ */
        .cutoff-row {
            background: linear-gradient(90deg, var(--peach-50) 0%, var(--peach-100) 100%);
            border-left: 3px solid #fb923c;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo } = React;

        // ============ é è¨­åƒæ•¸ ============
        const DEFAULT_CONFIG = {
            startTime: "08:30",
            earlyScanDuration: 35,
            delayedScanDuration: 20,
            uptakeTime: 60,
            minWaitLimit: 120,   // æ‰“è—¥åˆ° Delayed é–‹å§‹ çš„æœ€å°æ™‚é–“ (90-240)
            maxWaitLimit: 180,   // æ‰“è—¥åˆ° Delayed é–‹å§‹ çš„æœ€å¤§æ™‚é–“ (90-240)
            lunchBreakEnabled: false,
            lunchBreakStart: "12:00",
            lunchBreakEnd: "13:00",
            // Posluma PET è¨­å®š
            poslumaCount: 0,
            poslumaEarlyScan: 20,          // é è¨­ 20 åˆ†é˜
            poslumaDelayedScan: 0,         // é è¨­ä¸éœ€è¦ Delayed
            poslumaUptakeTime: 60,         // é è¨­ 60 åˆ†é˜
            poslumaInjectionTimes: [],     // è‡ªè¨‚æ‰“è—¥æ™‚é–“ ["09:00", "10:30"]
        };

        // ============ å·¥å…·å‡½æ•¸ ============
        const timeToMinutes = (timeStr) => {
            const [h, m] = timeStr.split(':').map(Number);
            return h * 60 + m;
        };

        const minutesToTime = (minutes) => {
            const h = Math.floor(minutes / 60);
            const m = minutes % 60;
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
        };

        // ============ æ ¸å¿ƒæ’ç¨‹æ¼”ç®—æ³•ï¼ˆFDG + Posluma æ··åˆæ’ç¨‹ï¼‰ ============
        const calculateSchedule = (fdgCount, config) => {
            const {
                startTime,
                earlyScanDuration,
                delayedScanDuration,
                uptakeTime,
                minWaitLimit,
                maxWaitLimit,
                lunchBreakEnabled,
                lunchBreakStart,
                lunchBreakEnd,
                poslumaCount,
                poslumaEarlyScan,
                poslumaDelayedScan,
                poslumaUptakeTime,
                poslumaInjectionTimes,
            } = config;

            const startMinutes = timeToMinutes(startTime);
            const lunchStart = lunchBreakEnabled ? timeToMinutes(lunchBreakStart) : null;
            const lunchEnd = lunchBreakEnabled ? timeToMinutes(lunchBreakEnd) : null;

            // åˆä¼‘é¿é–‹å‡½æ•¸
            const adjustForLunch = (proposedStart, duration) => {
                if (!lunchBreakEnabled) return proposedStart;
                const proposedEnd = proposedStart + duration;
                if (proposedStart < lunchEnd && proposedEnd > lunchStart) {
                    return lunchEnd;
                }
                return proposedStart;
            };

            // ç©ºæ’ç¨‹
            if (fdgCount === 0 && poslumaCount === 0) {
                return { mode: 'EMPTY', schedule: [], poslumaSchedule: [], batches: [], poslumaWarnings: [] };
            }

            // ========== ç¬¬ä¸€æ­¥ï¼šæ’ FDG ==========
            const fdgSchedule = [];
            const batches = [];
            const needDelayed = delayedScanDuration > 0;
            let machineTime = startMinutes + uptakeTime;

            if (fdgCount > 0) {
                if (!needDelayed) {
                    // FDG åƒ… Early æ¨¡å¼
                    for (let i = 0; i < fdgCount; i++) {
                        let earlyStart = machineTime;
                        earlyStart = adjustForLunch(earlyStart, earlyScanDuration);
                        const injTime = earlyStart - uptakeTime;
                        const earlyEnd = earlyStart + earlyScanDuration;
                        fdgSchedule.push({
                            id: i + 1,
                            type: 'FDG',
                            batch: 1,
                            injTime,
                            earlyStart,
                            earlyEnd,
                            delayedStart: null,
                            delayedEnd: null,
                        });
                        machineTime = earlyEnd;
                    }
                    batches.push({ batchNumber: 1, patients: fdgSchedule.map(p => p.id), firstInj: fdgSchedule[0].injTime, lastDelayedEnd: machineTime });
                } else {
                    // FDG éœ€è¦ Delayedï¼šåˆ†æ‰¹è™•ç†
                    const maxBatchSize = Math.floor((maxWaitLimit - uptakeTime) / earlyScanDuration);
                    if (maxBatchSize < 1) {
                        return {
                            mode: 'ERROR',
                            schedule: [],
                            poslumaSchedule: [],
                            batches: [],
                            poslumaWarnings: [],
                            error: `åƒæ•¸ä¸åˆç†ï¼šuptakeTime (${uptakeTime}) + è‡³å°‘ä¸€æ¬¡æƒæ å·²è¶…é maxWaitLimit (${maxWaitLimit})`
                        };
                    }

                    let patientId = 1;
                    let batchNumber = 1;
                    machineTime = startMinutes + uptakeTime;

                    while (patientId <= fdgCount) {
                        const batchSize = Math.min(maxBatchSize, fdgCount - patientId + 1);
                        const batchPatients = [];

                        for (let i = 0; i < batchSize; i++) {
                            let earlyStart = machineTime + i * earlyScanDuration;
                            earlyStart = adjustForLunch(earlyStart, earlyScanDuration);
                            if (i > 0) {
                                const prevEnd = batchPatients[i - 1].earlyEnd;
                                earlyStart = Math.max(earlyStart, prevEnd);
                                earlyStart = adjustForLunch(earlyStart, earlyScanDuration);
                            }
                            const injTime = earlyStart - uptakeTime;
                            const earlyEnd = earlyStart + earlyScanDuration;
                            batchPatients.push({
                                id: patientId + i,
                                type: 'FDG',
                                batch: batchNumber,
                                injTime,
                                earlyStart,
                                earlyEnd,
                                delayedStart: null,
                                delayedEnd: null,
                            });
                        }

                        machineTime = batchPatients[batchSize - 1].earlyEnd;

                        for (let i = 0; i < batchSize; i++) {
                            const patient = batchPatients[i];
                            const minDelayedStart = patient.injTime + minWaitLimit;
                            let delayedStart = Math.max(machineTime, minDelayedStart);
                            delayedStart = adjustForLunch(delayedStart, delayedScanDuration);
                            patient.delayedStart = delayedStart;
                            patient.delayedEnd = delayedStart + delayedScanDuration;
                            machineTime = patient.delayedEnd;
                        }

                        batches.push({
                            batchNumber,
                            patients: batchPatients.map(p => p.id),
                            firstInj: batchPatients[0].injTime,
                            lastDelayedEnd: machineTime,
                        });

                        fdgSchedule.push(...batchPatients);
                        patientId += batchSize;
                        batchNumber++;
                    }
                }
            }

            // ========== ç¬¬äºŒæ­¥ï¼šæ”¶é›†æ©Ÿå™¨ç©ºéš™ ==========
            const findGaps = () => {
                if (fdgSchedule.length === 0) {
                    return [{ start: startMinutes + poslumaUptakeTime, end: 24 * 60 }];
                }

                const occupiedSlots = [];
                fdgSchedule.forEach(p => {
                    occupiedSlots.push({ start: p.earlyStart, end: p.earlyEnd });
                    if (p.delayedStart !== null) {
                        occupiedSlots.push({ start: p.delayedStart, end: p.delayedEnd });
                    }
                });
                occupiedSlots.sort((a, b) => a.start - b.start);

                const gaps = [];
                let cursor = startMinutes + poslumaUptakeTime;
                occupiedSlots.forEach(slot => {
                    if (slot.start > cursor) {
                        gaps.push({ start: cursor, end: slot.start });
                    }
                    cursor = Math.max(cursor, slot.end);
                });
                // æœ€å¾Œä¸€å€‹ç©ºéš™å»¶ä¼¸åˆ°æ™šä¸Š
                gaps.push({ start: cursor, end: 24 * 60 });
                return gaps;
            };

            // ========== ç¬¬ä¸‰æ­¥ï¼šæ’ Posluma ==========
            const poslumaSchedule = [];
            const poslumaWarnings = [];
            const poslumaDelayedNeeded = poslumaDelayedScan > 0;

            // å»ºç«‹å·²ä½”ç”¨æ™‚æ®µï¼ˆåŒ…å« FDGï¼‰
            const allOccupied = [];
            fdgSchedule.forEach(p => {
                allOccupied.push({ start: p.earlyStart, end: p.earlyEnd });
                if (p.delayedStart !== null) {
                    allOccupied.push({ start: p.delayedStart, end: p.delayedEnd });
                }
            });

            // æª¢æŸ¥æ™‚æ®µæ˜¯å¦å¯ç”¨
            const isSlotAvailable = (start, end) => {
                // é¿é–‹åˆä¼‘
                if (lunchBreakEnabled && start < lunchEnd && end > lunchStart) {
                    return false;
                }
                // æª¢æŸ¥èˆ‡å·²ä½”ç”¨æ™‚æ®µè¡çª
                for (const slot of allOccupied) {
                    if (start < slot.end && end > slot.start) {
                        return false;
                    }
                }
                return true;
            };

            // æ‰¾åˆ°æœ€æ¥è¿‘ç›®æ¨™æ™‚é–“çš„å¯ç”¨æ™‚æ®µ
            const findNearestAvailableSlot = (targetEarlyStart, duration) => {
                // æœå°‹ç¯„åœï¼šå¾€å‰å¾Œå„ 3 å°æ™‚
                for (let offset = 0; offset <= 180; offset += 5) {
                    // å¾€å¾Œæ‰¾
                    let candidate = adjustForLunch(targetEarlyStart + offset, duration);
                    if (isSlotAvailable(candidate, candidate + duration)) {
                        return candidate;
                    }
                    // å¾€å‰æ‰¾
                    if (offset > 0) {
                        candidate = targetEarlyStart - offset;
                        if (candidate >= startMinutes) {
                            candidate = adjustForLunch(candidate, duration);
                            if (isSlotAvailable(candidate, candidate + duration)) {
                                return candidate;
                            }
                        }
                    }
                }
                // æ‰¾ä¸åˆ°ï¼Œæ”¾åˆ°æœ€å¾Œ
                let lastEnd = startMinutes + poslumaUptakeTime;
                allOccupied.forEach(slot => {
                    lastEnd = Math.max(lastEnd, slot.end);
                });
                return adjustForLunch(lastEnd, duration);
            };

            // ========== Posluma PET æ’ç¨‹ ==========

            for (let i = 0; i < poslumaCount; i++) {
                let warning = null;
                let injTime, earlyStart;

                // ä½¿ç”¨ç”¨æˆ¶è¨­å®šçš„æ™‚é–“ï¼Œè‹¥ç„¡å‰‡é è¨­ 14:00
                const userSetTime = config.poslumaInjectionTimes[i] || '14:00';
                const customInjTime = timeToMinutes(userSetTime);
                const targetEarlyStart = customInjTime + poslumaUptakeTime;

                // æª¢æŸ¥æ˜¯å¦èˆ‡å…¶ä»–æª¢æŸ¥è¡çª
                if (isSlotAvailable(targetEarlyStart, targetEarlyStart + poslumaEarlyScan)) {
                    // ç„¡è¡çªï¼Œä½¿ç”¨ç”¨æˆ¶è¨­å®šçš„æ™‚é–“
                    earlyStart = adjustForLunch(targetEarlyStart, poslumaEarlyScan);
                    injTime = earlyStart - poslumaUptakeTime;
                } else {
                    // æœ‰è¡çªï¼Œä»ä½¿ç”¨ç”¨æˆ¶è¨­å®šçš„æ™‚é–“ï¼Œä½†æä¾›å»ºè­°
                    earlyStart = adjustForLunch(targetEarlyStart, poslumaEarlyScan);
                    injTime = customInjTime;

                    // æ‰¾æœ€ä½³å»ºè­°æ™‚é–“
                    const suggestedStart = findNearestAvailableSlot(targetEarlyStart, poslumaEarlyScan);
                    const suggestedInjTime = suggestedStart - poslumaUptakeTime;

                    warning = {
                        patientId: `P${i + 1}`,
                        patientIndex: i,
                        originalTime: userSetTime,
                        suggestedTime: minutesToTime(suggestedInjTime),
                        reason: 'èˆ‡å…¶ä»–æª¢æŸ¥æ™‚é–“è¡çª',
                        suggestedValue: minutesToTime(suggestedInjTime)
                    };
                }

                const earlyEnd = earlyStart + poslumaEarlyScan;

                // â˜… å°‡ Early Scan åŠ å…¥ä½”ç”¨æ™‚æ®µ
                allOccupied.push({ start: earlyStart, end: earlyEnd });

                const patient = {
                    id: `P${i + 1}`,
                    type: 'POSLUMA',
                    batch: null,
                    injTime,
                    earlyStart,
                    earlyEnd,
                    delayedStart: null,
                    delayedEnd: null,
                };

                // Posluma Delayedï¼ˆå¦‚éœ€è¦ï¼‰
                if (poslumaDelayedNeeded) {
                    let delayedStart = earlyEnd;
                    delayedStart = adjustForLunch(delayedStart, poslumaDelayedScan);
                    // ç¢ºä¿ä¸èˆ‡å…¶ä»–æ™‚æ®µè¡çª
                    while (!isSlotAvailable(delayedStart, delayedStart + poslumaDelayedScan)) {
                        delayedStart += 5;
                        delayedStart = adjustForLunch(delayedStart, poslumaDelayedScan);
                    }
                    patient.delayedStart = delayedStart;
                    patient.delayedEnd = delayedStart + poslumaDelayedScan;
                    // â˜… ä¹ŸåŠ å…¥ä½”ç”¨æ™‚æ®µ
                    allOccupied.push({ start: patient.delayedStart, end: patient.delayedEnd });
                }

                poslumaSchedule.push(patient);
                if (warning) poslumaWarnings.push(warning);
            }

            // ========== æ•´åˆçµæœ ==========
            const allSchedule = [...fdgSchedule, ...poslumaSchedule].sort((a, b) => a.earlyStart - b.earlyStart);

            // è¨ˆç®—çµ±è¨ˆ
            let fdgWaitTimes = [];
            if (needDelayed && fdgSchedule.length > 0) {
                fdgWaitTimes = fdgSchedule.map(p => p.delayedStart - p.injTime);
            }
            const maxWait = fdgWaitTimes.length > 0 ? Math.max(...fdgWaitTimes) : null;
            const minWait = fdgWaitTimes.length > 0 ? Math.min(...fdgWaitTimes) : null;

            const allTimes = allSchedule.flatMap(p => [p.injTime, p.earlyEnd, p.delayedEnd].filter(t => t !== null));
            const firstInj = allTimes.length > 0 ? Math.min(...allTimes) : 0;
            const lastEnd = allTimes.length > 0 ? Math.max(...allTimes) : 0;

            let mode = 'MIXED';
            if (fdgCount === 0 && poslumaCount > 0) mode = 'POSLUMA_ONLY';
            else if (fdgCount > 0 && poslumaCount === 0) {
                mode = batches.length === 1 ? (needDelayed ? 'BATCH' : 'EARLY_ONLY') : 'AUTO_INTERLEAVED';
            }

            const summaryParts = [];
            if (fdgCount > 0) summaryParts.push(`FDG ${fdgCount} ä½`);
            if (poslumaCount > 0) summaryParts.push(`Posluma ${poslumaCount} ä½`);

            // ========== è¨ˆç®—å„ªåŒ–å»ºè­° ==========
            const optimizationSuggestions = [];

            if (allSchedule.length > 0) {
                // è¨ˆç®—æ©Ÿå™¨é–’ç½®æ™‚é–“
                const sortedSlots = [...allOccupied].sort((a, b) => a.start - b.start);
                let totalIdleTime = 0;
                let idleGaps = [];

                for (let i = 0; i < sortedSlots.length - 1; i++) {
                    const gap = sortedSlots[i + 1].start - sortedSlots[i].end;
                    if (gap > 5) { // å¤§æ–¼ 5 åˆ†é˜æ‰ç®—é–’ç½®
                        totalIdleTime += gap;
                        idleGaps.push({ start: sortedSlots[i].end, end: sortedSlots[i + 1].start, duration: gap });
                    }
                }

                // å»ºè­° 1: å¦‚æœæœ‰å¤§ç©ºéš™ï¼Œå»ºè­°èª¿æ•´é–‹å§‹æ™‚é–“
                const firstStart = Math.min(...sortedSlots.map(s => s.start));
                const potentialEarlierStart = firstStart - uptakeTime;
                if (potentialEarlierStart > startMinutes && (firstStart - startMinutes - uptakeTime) > 15) {
                    const suggestedStartTime = minutesToTime(potentialEarlierStart);
                    optimizationSuggestions.push({
                        type: 'startTime',
                        title: 'å»ºè­°èª¿æ•´æ‰“è—¥æ™‚é–“',
                        description: `ç›®å‰ç¬¬ä¸€æ¬¡æ‰“è—¥å¯æå‰è‡³ ${suggestedStartTime}ï¼Œæ©Ÿå™¨å¯æ›´æ—©é–‹å§‹é‹ä½œ`,
                        currentValue: config.startTime,
                        suggestedValue: suggestedStartTime,
                        impact: `å¯æå‰ ${Math.round((firstStart - startMinutes - uptakeTime))} åˆ†é˜å®Œæˆ`
                    });
                }

                // å»ºè­° 2: å¦‚æœç­‰å¾…æ™‚é–“æ¥è¿‘ä¸Šé™ï¼Œå»ºè­°èª¿æ•´ç­‰å¾…æ™‚é–“é™åˆ¶
                if (maxWait !== null && maxWait > maxWaitLimit - 10) {
                    const suggestedMaxWait = Math.min(239, maxWait + 20); // æœ€å¤§ 239
                    if (suggestedMaxWait > config.minWaitLimit && suggestedMaxWait <= 239) {
                        optimizationSuggestions.push({
                            type: 'maxWaitLimit',
                            title: 'å»ºè­°æ”¾å¯¬ç­‰å¾…æ™‚é–“ä¸Šé™',
                            description: `ç›®å‰æœ€å¤§ç­‰å¾… ${maxWait} åˆ†é˜ï¼Œæ¥è¿‘ä¸Šé™ ${maxWaitLimit} åˆ†é˜`,
                            currentValue: maxWaitLimit,
                            suggestedValue: suggestedMaxWait,
                            impact: `å¯æ¸›å°‘æ‰¹æ¬¡æ•¸ã€å„ªåŒ–æ’ç¨‹é€£çºŒæ€§`
                        });
                    }
                }

                // å»ºè­° 3: å¦‚æœé–’ç½®æ™‚é–“éé•· (>= 20åˆ†é˜)ï¼Œå»ºè­°èª¿æ•´ç­‰å¾…æ™‚é–“ä¸‹é™
                // åªæœ‰ç•¶çœŸçš„æœ‰é–’ç½®ç©ºéš™æ™‚æ‰é¡¯ç¤º
                if (totalIdleTime >= 20 && idleGaps.length > 0 && minWaitLimit > 91) {
                    const suggestedMinWait = Math.max(91, minWaitLimit - Math.min(20, totalIdleTime)); // æœ€å° 91
                    if (suggestedMinWait >= 91 && suggestedMinWait < config.maxWaitLimit) {
                        optimizationSuggestions.push({
                            type: 'minWaitLimit',
                            title: 'å»ºè­°ç¸®çŸ­ç­‰å¾…æ™‚é–“ä¸‹é™',
                            description: `æ©Ÿå™¨é–’ç½®å…± ${totalIdleTime} åˆ†é˜ï¼Œå¯ç¸®çŸ­ç—…äººç­‰å¾…`,
                            currentValue: minWaitLimit,
                            suggestedValue: suggestedMinWait,
                            impact: `æ¸›å°‘é–’ç½®ç´„ ${Math.min(totalIdleTime, minWaitLimit - suggestedMinWait)} åˆ†é˜`
                        });
                    }
                }

                // å»ºè­° 4: å¦‚æœæœ€å¾ŒçµæŸæ™‚é–“å¤ªæ™š
                if (lastEnd > 17 * 60) { // ä¸‹åˆ 5 é»å¾Œ
                    const suggestedStartTime = minutesToTime(Math.max(8 * 60, timeToMinutes(config.startTime) - 30));
                    if (suggestedStartTime !== config.startTime) {
                        optimizationSuggestions.push({
                            type: 'startTime',
                            title: 'å»ºè­°ææ—©é–‹å§‹æ‰“è—¥',
                            description: `ç›®å‰çµæŸæ™‚é–“ç‚º ${minutesToTime(lastEnd)}ï¼Œå»ºè­°ææ—©é–‹å§‹`,
                            currentValue: config.startTime,
                            suggestedValue: suggestedStartTime,
                            impact: `é è¨ˆææ—© 30 åˆ†é˜çµæŸ`
                        });
                    }
                }
            }

            // ========== è¨ˆç®—ç©ºæ©Ÿæ™‚é–“ ==========
            let machineIdleTime = 0;
            if (allSchedule.length > 0) {
                // æ”¶é›†æ‰€æœ‰æƒææ™‚æ®µ
                const scanSlots = [];
                allSchedule.forEach(p => {
                    scanSlots.push({ start: p.earlyStart, end: p.earlyEnd });
                    if (p.delayedStart !== null) {
                        scanSlots.push({ start: p.delayedStart, end: p.delayedEnd });
                    }
                });

                // æŒ‰é–‹å§‹æ™‚é–“æ’åº
                scanSlots.sort((a, b) => a.start - b.start);

                // è¨ˆç®—ç©ºéš™æ™‚é–“
                const firstScanStart = scanSlots[0].start;
                const lastScanEnd = scanSlots[scanSlots.length - 1].end;

                // æ‰¾å‡ºæ‰€æœ‰ç©ºéš™
                for (let i = 0; i < scanSlots.length - 1; i++) {
                    const gap = scanSlots[i + 1].start - scanSlots[i].end;
                    if (gap > 0) {
                        machineIdleTime += gap;
                    }
                }
            }

            return {
                mode,
                schedule: allSchedule,
                fdgSchedule,
                poslumaSchedule,
                batches,
                poslumaWarnings,
                optimizationSuggestions,
                machineIdleTime,
                maxBatchSize: batches.length > 0 ? Math.floor((maxWaitLimit - uptakeTime) / earlyScanDuration) : null,
                maxPatientWaitTime: maxWait,
                minPatientWaitTime: minWait,
                totalDuration: lastEnd - firstInj,
                summary: summaryParts.join(' + ') + (batches.length > 1 ? `ï¼ŒFDG åˆ† ${batches.length} æ‰¹` : ''),
            };
        };

        // ============ ç”Ÿæˆå·¥ä½œæ¸…å–® ============
        const generateWorklist = (schedule) => {
            const tasks = [];

            schedule.forEach((patient) => {
                tasks.push({
                    time: patient.earlyStart,
                    endTime: patient.earlyEnd,
                    type: 'EARLY',
                    patientId: patient.id,
                    patientType: patient.type || 'FDG',
                    duration: patient.earlyEnd - patient.earlyStart,
                });

                if (patient.delayedStart !== null) {
                    tasks.push({
                        time: patient.delayedStart,
                        endTime: patient.delayedEnd,
                        type: 'DELAYED',
                        patientId: patient.id,
                        patientType: patient.type || 'FDG',
                        duration: patient.delayedEnd - patient.delayedStart,
                    });
                }
            });

            tasks.sort((a, b) => a.time - b.time);
            return tasks;
        };

        // ============ é†«å¸«è¦åŠƒé¢æ¿ ============
        const PlannerTab = ({ schedule, result, config }) => {
            const ganttData = useMemo(() => {
                if (!schedule.length) return { tasks: [], minTime: 0, maxTime: 0 };

                const tasks = [];
                schedule.forEach((p) => {
                    tasks.push({ patientId: p.id, type: 'EARLY', start: p.earlyStart, end: p.earlyEnd });
                    if (p.delayedStart !== null) {
                        tasks.push({ patientId: p.id, type: 'DELAYED', start: p.delayedStart, end: p.delayedEnd });
                    }
                });

                const allTimes = tasks.flatMap(t => [t.start, t.end]);
                return { tasks, minTime: Math.min(...allTimes), maxTime: Math.max(...allTimes) };
            }, [schedule]);

            const getBarColor = (type) => {
                return type === 'EARLY'
                    ? 'background: linear-gradient(135deg, #93c5fd 0%, #60a5fa 100%)'
                    : 'background: linear-gradient(135deg, #fdba74 0%, #fb923c 100%)';
            };

            const getBarPosition = (start, end, minTime, maxTime) => {
                const totalDuration = maxTime - minTime || 1;
                const left = ((start - minTime) / totalDuration) * 100;
                const width = ((end - start) / totalDuration) * 100;
                return { left: `${left}%`, width: `${Math.max(width, 1)}%` };
            };

            const timeMarkers = useMemo(() => {
                if (!schedule.length) return [];
                const { minTime, maxTime } = ganttData;
                const markers = [];
                const start = Math.floor(minTime / 30) * 30;
                for (let t = start; t <= maxTime; t += 30) {
                    const pos = ((t - minTime) / (maxTime - minTime || 1)) * 100;
                    markers.push({ time: t, pos });
                }
                return markers;
            }, [ganttData, schedule.length]);

            return (
                <div style={{ display: 'flex', flexDirection: 'column', gap: '24px' }}>
                    {/* æ‰“è—¥æ™‚åˆ»è¡¨ */}
                    <div className="card printable-section" style={{ overflow: 'hidden' }}>
                        <div style={{
                            padding: '20px 24px',
                            borderBottom: '1px solid #f3e8ff',
                            background: 'linear-gradient(135deg, var(--lavender-50) 0%, var(--pink-50) 100%)'
                        }}>
                            <h3 style={{ margin: 0, fontSize: '18px', fontWeight: 700, color: 'var(--warm-gray-800)', display: 'flex', alignItems: 'center', gap: '10px' }}>
                                <i className="fa-solid fa-syringe" style={{ fontSize: '18px', color: '#e11d48' }}></i>
                                å»ºè­°æ‰“è—¥æ™‚åˆ»è¡¨
                            </h3>
                            <p style={{ margin: '6px 0 0 0', fontSize: '14px', color: 'var(--warm-gray-600)' }}>
                                å°‡æ­¤è¡¨äº¤çµ¦è­·ç†å¸«ï¼Œç…§è¡¨æ‰“è—¥å³å¯
                            </p>
                        </div>

                        <div style={{ overflowX: 'auto' }}>
                            <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: '14px' }}>
                                <thead>
                                    <tr style={{ background: 'var(--warm-gray-50)', color: 'var(--warm-gray-600)' }}>
                                        <th style={{ padding: '14px 16px', textAlign: 'left', fontWeight: 600 }}>åºè™Ÿ</th>
                                        <th style={{ padding: '14px 16px', textAlign: 'left', fontWeight: 600 }}>
                                            <i className="fa-solid fa-syringe" style={{ color: '#e11d48', marginRight: '6px' }}></i> æ‰“è—¥æ™‚é–“
                                        </th>
                                        <th style={{ padding: '14px 16px', textAlign: 'left', fontWeight: 600 }}>
                                            <i className="fa-solid fa-bolt" style={{ color: '#3b82f6', marginRight: '6px' }}></i> Early Scan
                                        </th>
                                        <th style={{ padding: '14px 16px', textAlign: 'left', fontWeight: 600 }}>
                                            <i className="fa-regular fa-clock" style={{ color: '#f97316', marginRight: '6px' }}></i> Delayed Scan
                                        </th>
                                        <th style={{ padding: '14px 16px', textAlign: 'left', fontWeight: 600 }}>
                                            ç­‰å¾…æ™‚é–“ <span style={{ fontSize: '11px', fontWeight: 400, color: 'var(--warm-gray-400)' }}>(æ‰“è—¥â†’Delayedé–‹å§‹)</span>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {schedule.map((p, idx) => {
                                        const waitTime = p.delayedStart !== null ? p.delayedStart - p.injTime : null;
                                        const isOverLimit = waitTime !== null && p.type === 'FDG' && waitTime > config.maxWaitLimit;
                                        const isNewBatch = idx > 0 && schedule[idx - 1].batch !== p.batch && p.batch !== null;
                                        const isPosluma = p.type === 'POSLUMA';

                                        return (
                                            <tr
                                                key={p.id}
                                                className="table-row"
                                                style={{
                                                    borderBottom: '1px solid var(--warm-gray-100)',
                                                    transition: 'background 0.15s',
                                                    borderTop: isNewBatch ? '3px solid #93c5fd' : 'none',
                                                    background: isPosluma ? 'linear-gradient(90deg, #ecfdf5 0%, #f0fdf4 100%)' : 'transparent'
                                                }}
                                            >
                                                <td style={{ padding: '14px 16px', fontWeight: 600, color: 'var(--warm-gray-800)' }}>
                                                    <span style={{
                                                        display: 'inline-flex',
                                                        alignItems: 'center',
                                                        gap: '6px'
                                                    }}>
                                                        {isPosluma ? (
                                                            <span style={{
                                                                background: 'linear-gradient(135deg, #34d399 0%, #10b981 100%)',
                                                                padding: '2px 8px',
                                                                borderRadius: '6px',
                                                                fontSize: '10px',
                                                                fontWeight: 700,
                                                                color: 'white'
                                                            }}>Posluma</span>
                                                        ) : (
                                                            <span style={{
                                                                background: 'linear-gradient(135deg, #fca5a5 0%, #f87171 100%)',
                                                                padding: '2px 8px',
                                                                borderRadius: '6px',
                                                                fontSize: '10px',
                                                                fontWeight: 700,
                                                                color: 'white'
                                                            }}>FDG</span>
                                                        )}
                                                        {p.id}
                                                    </span>
                                                    {!isPosluma && result.batches && result.batches.length > 1 && (
                                                        <span style={{
                                                            marginLeft: '8px',
                                                            fontSize: '11px',
                                                            background: `hsl(${210 + (p.batch - 1) * 30}, 80%, 85%)`,
                                                            color: `hsl(${210 + (p.batch - 1) * 30}, 60%, 35%)`,
                                                            padding: '2px 8px',
                                                            borderRadius: '10px'
                                                        }}>
                                                            ç¬¬ {p.batch} æ‰¹
                                                        </span>
                                                    )}
                                                </td>
                                                <td style={{ padding: '14px 16px', color: isPosluma ? '#059669' : '#e11d48', fontWeight: 700 }}>
                                                    {minutesToTime(p.injTime)}
                                                </td>
                                                <td style={{ padding: '14px 16px', color: isPosluma ? '#047857' : '#2563eb', fontWeight: 500 }}>
                                                    {minutesToTime(p.earlyStart)}-{minutesToTime(p.earlyEnd)}
                                                </td>
                                                <td style={{ padding: '14px 16px', color: '#ea580c', fontWeight: 500 }}>
                                                    {p.delayedStart ? `${minutesToTime(p.delayedStart)}-${minutesToTime(p.delayedEnd)}` : '-'}
                                                </td>
                                                <td style={{ padding: '14px 16px' }}>
                                                    {waitTime !== null ? (
                                                        <span style={{
                                                            color: isOverLimit ? '#dc2626' : '#16a34a',
                                                            fontWeight: 600
                                                        }}>
                                                            {Math.floor(waitTime / 60)}h {waitTime % 60}m
                                                            {isOverLimit && ' âš ï¸'}
                                                        </span>
                                                    ) : (
                                                        <span style={{ color: 'var(--warm-gray-400)' }}>-</span>
                                                    )}
                                                </td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    {/* ç”˜ç‰¹åœ– - æ ¼å­ç‹€æ™‚é–“è»¸ */}
                    {schedule.length > 0 && (() => {
                        // è¨ˆç®—æ™‚é–“ç¯„åœï¼Œå°é½Šåˆ°30åˆ†é˜
                        const allTimes = schedule.flatMap(p => [p.earlyStart, p.earlyEnd, p.delayedStart, p.delayedEnd].filter(t => t !== null));
                        const rawMin = Math.min(...allTimes);
                        const rawMax = Math.max(...allTimes);
                        const gridStart = Math.floor(rawMin / 30) * 30;
                        const gridEnd = Math.ceil(rawMax / 30) * 30;
                        const totalCells = (gridEnd - gridStart) / 5; // æ¯5åˆ†é˜ä¸€æ ¼
                        const cellWidth = 12; // æ¯æ ¼å¯¬åº¦(px) - ç¸®å°ä»¥æ¸›å°‘æ»¾å‹•

                        // ç”Ÿæˆæ™‚é–“æ¨™è¨˜ï¼ˆæ¯30åˆ†é˜ï¼‰
                        const hourMarkers = [];
                        for (let t = gridStart; t <= gridEnd; t += 30) {
                            hourMarkers.push(t);
                        }

                        // åˆ¤æ–·ä»»å‹™ä½”ç”¨å“ªäº›æ ¼å­
                        const getCellRange = (start, end) => {
                            const startCell = Math.floor((start - gridStart) / 5);
                            const endCell = Math.ceil((end - gridStart) / 5);
                            return { startCell, endCell, span: endCell - startCell };
                        };

                        return (
                            <div className="card" style={{ overflow: 'hidden' }}>
                                <div style={{
                                    padding: '20px 24px',
                                    borderBottom: '1px solid #dbeafe',
                                    background: 'linear-gradient(135deg, var(--mint-50) 0%, #ecfeff 100%)'
                                }}>
                                    <h3 style={{ margin: 0, fontSize: '18px', fontWeight: 700, color: 'var(--warm-gray-800)', display: 'flex', alignItems: 'center', gap: '10px' }}>
                                        <span style={{ fontSize: '20px' }}>ğŸ“Š</span>
                                        æ©Ÿå™¨ä½¿ç”¨æ™‚é–“è»¸
                                        <span style={{ fontSize: '12px', fontWeight: 400, color: 'var(--warm-gray-500)', marginLeft: '8px' }}>
                                            ï¼ˆæ¯å°æ ¼ 5 åˆ†é˜ï¼‰
                                        </span>
                                    </h3>
                                </div>

                                <div style={{ padding: '24px', overflowX: 'auto' }}>
                                    {/* åœ–ä¾‹ */}
                                    <div style={{ display: 'flex', gap: '16px', marginBottom: '20px', fontSize: '13px', flexWrap: 'wrap' }}>
                                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                            <div style={{ width: '16px', height: '16px', borderRadius: '4px', background: 'linear-gradient(135deg, #93c5fd 0%, #60a5fa 100%)' }}></div>
                                            <span style={{ color: 'var(--warm-gray-600)' }}>FDG Early</span>
                                        </div>
                                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                            <div style={{ width: '16px', height: '16px', borderRadius: '4px', background: 'linear-gradient(135deg, #fdba74 0%, #fb923c 100%)' }}></div>
                                            <span style={{ color: 'var(--warm-gray-600)' }}>FDG Delayed</span>
                                        </div>
                                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                            <div style={{ width: '16px', height: '16px', borderRadius: '4px', background: 'linear-gradient(135deg, #6ee7b7 0%, #34d399 100%)' }}></div>
                                            <span style={{ color: 'var(--warm-gray-600)' }}>Posluma</span>
                                        </div>
                                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                            <div style={{ width: '16px', height: '16px', borderRadius: '4px', background: 'var(--warm-gray-100)', border: '1px solid var(--warm-gray-200)' }}></div>
                                            <span style={{ color: 'var(--warm-gray-600)' }}>ç©ºé–’</span>
                                        </div>
                                    </div>

                                    <div style={{ display: 'inline-block', minWidth: 'fit-content' }}>
                                        {/* æ™‚é–“è»¸æ¨™é ­ */}
                                        <div style={{ display: 'flex', alignItems: 'flex-end', marginBottom: '4px', paddingLeft: '70px' }}>
                                            {hourMarkers.map((t, idx) => (
                                                <div key={idx} style={{
                                                    width: `${cellWidth * 6}px`,
                                                    textAlign: 'left',
                                                    fontSize: '11px',
                                                    fontWeight: 600,
                                                    color: 'var(--warm-gray-600)'
                                                }}>
                                                    {minutesToTime(t)}
                                                </div>
                                            ))}
                                        </div>

                                        {/* æ ¼å­è¡¨æ ¼ */}
                                        <div style={{ display: 'flex', flexDirection: 'column', gap: '4px' }}>
                                            {schedule.map((patient) => {
                                                const earlyRange = getCellRange(patient.earlyStart, patient.earlyEnd);
                                                const delayedRange = patient.delayedStart ? getCellRange(patient.delayedStart, patient.delayedEnd) : null;
                                                const isPosluma = patient.type === 'POSLUMA';

                                                return (
                                                    <div key={patient.id} style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                                                        <div style={{
                                                            width: '60px',
                                                            fontSize: '12px',
                                                            color: isPosluma ? '#059669' : 'var(--warm-gray-600)',
                                                            fontWeight: 600,
                                                            textAlign: 'right',
                                                            display: 'flex',
                                                            alignItems: 'center',
                                                            justifyContent: 'flex-end',
                                                            gap: '4px'
                                                        }}>
                                                            {isPosluma && <span style={{ fontSize: '9px', background: '#10b981', color: 'white', padding: '1px 4px', borderRadius: '3px' }}>P</span>}
                                                            {patient.id}
                                                        </div>
                                                        <div style={{ display: 'flex' }}>
                                                            {Array.from({ length: totalCells }, (_, cellIdx) => {
                                                                const isEarly = cellIdx >= earlyRange.startCell && cellIdx < earlyRange.endCell;
                                                                const isDelayed = delayedRange && cellIdx >= delayedRange.startCell && cellIdx < delayedRange.endCell;
                                                                const is30MinBorder = (cellIdx + 1) % 6 === 0;

                                                                let bg = 'var(--warm-gray-50)';
                                                                let title = '';
                                                                if (isEarly) {
                                                                    bg = isPosluma
                                                                        ? 'linear-gradient(135deg, #6ee7b7 0%, #34d399 100%)'
                                                                        : 'linear-gradient(135deg, #93c5fd 0%, #60a5fa 100%)';
                                                                    title = `${isPosluma ? 'Posluma' : 'FDG'} Early: ${minutesToTime(patient.earlyStart)} - ${minutesToTime(patient.earlyEnd)}`;
                                                                } else if (isDelayed) {
                                                                    bg = isPosluma
                                                                        ? 'linear-gradient(135deg, #a7f3d0 0%, #6ee7b7 100%)'
                                                                        : 'linear-gradient(135deg, #fdba74 0%, #fb923c 100%)';
                                                                    title = `${isPosluma ? 'Posluma' : 'FDG'} Delayed: ${minutesToTime(patient.delayedStart)} - ${minutesToTime(patient.delayedEnd)}`;
                                                                }

                                                                return (
                                                                    <div
                                                                        key={cellIdx}
                                                                        title={title}
                                                                        style={{
                                                                            width: `${cellWidth}px`,
                                                                            height: '24px',
                                                                            background: bg,
                                                                            borderRight: is30MinBorder ? '2px solid var(--warm-gray-300)' : '1px solid var(--warm-gray-200)',
                                                                            borderTop: '1px solid var(--warm-gray-200)',
                                                                            borderBottom: '1px solid var(--warm-gray-200)',
                                                                            borderLeft: cellIdx === 0 ? '2px solid var(--warm-gray-300)' : 'none',
                                                                            transition: 'transform 0.15s',
                                                                            cursor: (isEarly || isDelayed) ? 'pointer' : 'default',
                                                                        }}
                                                                        onMouseOver={(e) => {
                                                                            if (isEarly || isDelayed) e.target.style.transform = 'scaleY(1.2)';
                                                                        }}
                                                                        onMouseOut={(e) => {
                                                                            e.target.style.transform = 'scaleY(1)';
                                                                        }}
                                                                    ></div>
                                                                );
                                                            })}
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        );
                    })()}

                    {/* åˆ—å°ç°½åæ¬„ */}
                    <div className="print-only" style={{ background: 'white', padding: '24px', marginTop: '32px', borderTop: '2px solid var(--warm-gray-300)' }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                            <p style={{ fontSize: '14px', color: 'var(--warm-gray-600)' }}>æ’ç¨‹é†«å¸«ç°½åï¼š__________________</p>
                            <p style={{ fontSize: '14px', color: 'var(--warm-gray-600)' }}>åˆ—å°æ—¥æœŸï¼š{new Date().toLocaleDateString('zh-TW')}</p>
                        </div>
                    </div>
                </div>
            );
        };

        // ============ æ”¾å°„å¸«å·¥ä½œæ¸…å–® ============
        const WorklistTab = ({ schedule, result }) => {
            const [completedTasks, setCompletedTasks] = useState({});
            const worklist = useMemo(() => generateWorklist(schedule), [schedule]);

            const toggleComplete = (index) => {
                setCompletedTasks(prev => ({ ...prev, [index]: !prev[index] }));
            };

            const completedCount = Object.values(completedTasks).filter(Boolean).length;
            const progress = worklist.length > 0 ? (completedCount / worklist.length) * 100 : 0;

            return (
                <div style={{ display: 'flex', flexDirection: 'column', gap: '24px' }}>
                    {/* å·¥ä½œæ¸…å–® */}
                    <div className="card printable-section" style={{ overflow: 'hidden' }}>
                        <div style={{
                            padding: '20px 24px',
                            borderBottom: '1px solid #dcfce7',
                            background: 'linear-gradient(135deg, var(--mint-50) 0%, var(--mint-100) 100%)'
                        }}>
                            <h3 style={{ margin: 0, fontSize: '18px', fontWeight: 700, color: 'var(--warm-gray-800)', display: 'flex', alignItems: 'center', gap: '10px' }}>
                                <i className="fa-solid fa-clipboard-check" style={{ fontSize: '18px', color: '#16a34a' }}></i>
                                åŸ·è¡Œæ¸…å–®
                            </h3>
                            <p style={{ margin: '6px 0 0 0', fontSize: '14px', color: 'var(--warm-gray-600)' }}>
                                ä¾æ™‚é–“æ’åºï¼Œç…§é †åºåŸ·è¡Œå³å¯
                            </p>
                        </div>

                        <div>
                            {worklist.map((task, idx) => {
                                const isDelayed = task.type === 'DELAYED';
                                const isPosluma = task.patientType === 'POSLUMA';

                                return (
                                    <div
                                        key={idx}
                                        style={{
                                            display: 'flex',
                                            alignItems: 'center',
                                            gap: '16px',
                                            padding: '14px 24px',
                                            borderBottom: '1px solid var(--warm-gray-100)',
                                            flexWrap: 'wrap',
                                            background: isPosluma ? 'linear-gradient(90deg, rgba(236, 253, 245, 0.5) 0%, transparent 100%)' : 'transparent'
                                        }}
                                    >
                                        {/* åºè™Ÿ */}
                                        <div style={{
                                            width: '28px',
                                            height: '28px',
                                            borderRadius: '50%',
                                            background: isPosluma ? '#d1fae5' : 'var(--warm-gray-200)',
                                            color: isPosluma ? '#059669' : 'var(--warm-gray-600)',
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'center',
                                            fontSize: '13px',
                                            fontWeight: 600
                                        }}>
                                            {idx + 1}
                                        </div>

                                        {/* æ™‚é–“ */}
                                        <div style={{ minWidth: '100px' }}>
                                            <div style={{
                                                fontSize: '17px',
                                                fontWeight: 700,
                                                color: 'var(--warm-gray-800)'
                                            }}>
                                                {minutesToTime(task.time)}-{minutesToTime(task.endTime)}
                                            </div>
                                        </div>

                                        {/* ç—…äººç·¨è™Ÿ + é¡å‹ */}
                                        <div style={{
                                            minWidth: '100px',
                                            display: 'flex',
                                            alignItems: 'center',
                                            gap: '6px'
                                        }}>
                                            <span style={{
                                                background: isPosluma
                                                    ? 'linear-gradient(135deg, #34d399 0%, #10b981 100%)'
                                                    : 'linear-gradient(135deg, #fca5a5 0%, #f87171 100%)',
                                                padding: '2px 6px',
                                                borderRadius: '4px',
                                                fontSize: '9px',
                                                fontWeight: 700,
                                                color: 'white'
                                            }}>{isPosluma ? 'Posluma' : 'FDG'}</span>
                                            <span style={{ fontWeight: 600, color: 'var(--warm-gray-700)' }}>{task.patientId}</span>
                                        </div>

                                        {/* ä»»å‹™é¡å‹ */}
                                        <div>
                                            {isDelayed ? (
                                                <span style={{
                                                    display: 'inline-flex',
                                                    alignItems: 'center',
                                                    gap: '6px',
                                                    padding: '5px 12px',
                                                    borderRadius: '16px',
                                                    background: 'linear-gradient(135deg, #ffedd5 0%, #fed7aa 100%)',
                                                    color: '#c2410c',
                                                    fontSize: '13px',
                                                    fontWeight: 600
                                                }}>
                                                    <i className="fa-regular fa-clock" style={{ marginRight: '4px' }}></i> Delayed
                                                </span>
                                            ) : (
                                                <span style={{
                                                    display: 'inline-flex',
                                                    alignItems: 'center',
                                                    gap: '6px',
                                                    padding: '5px 12px',
                                                    borderRadius: '16px',
                                                    background: isPosluma
                                                        ? 'linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%)'
                                                        : 'linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%)',
                                                    color: isPosluma ? '#047857' : '#1d4ed8',
                                                    fontSize: '13px',
                                                    fontWeight: 600
                                                }}>
                                                    <i className="fa-solid fa-bolt" style={{ marginRight: '4px' }}></i> Early
                                                </span>
                                            )}
                                        </div>

                                        {/* å·¥æ™‚ */}
                                        <div style={{ fontSize: '13px', color: 'var(--warm-gray-500)', marginLeft: 'auto' }}>
                                            {task.duration}min
                                        </div>
                                    </div>
                                );
                            })}

                            {worklist.length === 0 && (
                                <div style={{ padding: '48px', textAlign: 'center', color: 'var(--warm-gray-400)' }}>
                                    <i className="fa-regular fa-folder-open" style={{ fontSize: '40px', marginBottom: '12px', display: 'block' }}></i>
                                    <p>å°šæœªç”¢ç”Ÿæ’ç¨‹</p>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* åˆ—å°ç°½åæ¬„ */}
                    <div className="print-only" style={{ background: 'white', padding: '24px', marginTop: '32px', borderTop: '2px solid var(--warm-gray-300)' }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                            <p style={{ fontSize: '14px', color: 'var(--warm-gray-600)' }}>åŸ·è¡Œæ”¾å°„å¸«ç°½åï¼š__________________</p>
                            <p style={{ fontSize: '14px', color: 'var(--warm-gray-600)' }}>æ—¥æœŸï¼š{new Date().toLocaleDateString('zh-TW')}</p>
                        </div>
                    </div>
                </div>
            );
        };

        // ============ ä¸»æ‡‰ç”¨ç¨‹å¼ ============
        const App = () => {
            const [patientCount, setPatientCount] = useState(5);
            const [config, setConfig] = useState(DEFAULT_CONFIG);
            const [activeTab, setActiveTab] = useState('planner');
            const [poslumaExpanded, setPoslumaExpanded] = useState(false);

            const result = useMemo(() => calculateSchedule(patientCount, config), [patientCount, config]);

            const handlePrint = () => window.print();

            const handleConfigChange = (key, value) => {
                setConfig(prev => ({ ...prev, [key]: value }));
                // ç•¶ Posluma æ•¸é‡å¤§æ–¼ 0 æ™‚è‡ªå‹•å±•é–‹
                if (key === 'poslumaCount' && value > 0) {
                    setPoslumaExpanded(true);
                }
            };

            return (
                <div style={{ minHeight: '100vh' }}>
                    {/* é ‚éƒ¨å°èˆª */}
                    <header className="no-print" style={{
                        background: 'linear-gradient(135deg, #fce7f3 0%, #e9d5ff 50%, #dbeafe 100%)',
                        borderBottom: '1px solid rgba(0,0,0,0.05)',
                        padding: '16px 0'
                    }}>
                        <div style={{ maxWidth: '1000px', margin: '0 auto', padding: '0 20px', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                                <div style={{
                                    width: '44px',
                                    height: '44px',
                                    background: 'white',
                                    borderRadius: '14px',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    boxShadow: '0 2px 8px rgba(0,0,0,0.06)',
                                    fontSize: '22px'
                                }}>
                                    ğŸ©º
                                </div>
                                <div>
                                    <h1 style={{ margin: 0, fontSize: '20px', fontWeight: 700, color: 'var(--warm-gray-800)' }}>
                                        PET æ™ºæ…§æ’ç¨‹åŠ©æ‰‹
                                    </h1>
                                    <p style={{ margin: 0, fontSize: '12px', color: 'var(--warm-gray-600)' }}>Smart PET Scheduler</p>
                                    <p style={{ margin: 0, fontSize: '10px', color: 'var(--warm-gray-400)' }}>Created by Huang Chun-Yin</p>
                                </div>
                            </div>

                            <button onClick={handlePrint} className="btn-soft" style={{
                                display: 'flex',
                                alignItems: 'center',
                                gap: '8px',
                                padding: '10px 18px',
                                background: 'white',
                                border: 'none',
                                borderRadius: '12px',
                                cursor: 'pointer',
                                fontSize: '14px',
                                fontWeight: 600,
                                color: 'var(--warm-gray-700)',
                                boxShadow: '0 2px 8px rgba(0,0,0,0.06)'
                            }}>
                                ğŸ–¨ï¸ åˆ—å°
                            </button>
                        </div>
                    </header>

                    <main style={{ maxWidth: '1000px', margin: '0 auto', padding: '24px 20px' }}>
                        {/* åƒæ•¸è¼¸å…¥å€ */}
                        <div className="no-print card" style={{ marginBottom: '24px', overflow: 'hidden' }}>
                            <div style={{ padding: '24px' }}>
                                <div style={{ display: 'flex', flexWrap: 'wrap', alignItems: 'flex-end', gap: '24px' }}>
                                    {/* FDG ç—…äººæ•¸é‡ */}
                                    <div style={{ flex: '1', minWidth: '200px' }}>
                                        <label style={{ display: 'block', fontSize: '13px', fontWeight: 600, color: 'var(--warm-gray-600)', marginBottom: '8px' }}>
                                            <span style={{ background: 'linear-gradient(135deg, #fecaca 0%, #fca5a5 100%)', padding: '2px 8px', borderRadius: '6px', marginRight: '6px', fontSize: '11px' }}>FDG</span>
                                            ç—…äººæ•¸é‡
                                        </label>
                                        <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                                            <button onClick={() => setPatientCount(Math.max(0, patientCount - 1))} className="btn-soft" style={{
                                                width: '40px', height: '40px', borderRadius: '12px',
                                                background: 'var(--pink-100)', border: 'none', cursor: 'pointer',
                                                fontSize: '18px', color: 'var(--pink-500)'
                                            }}>âˆ’</button>
                                            <input
                                                type="number"
                                                value={patientCount}
                                                onChange={(e) => setPatientCount(Math.max(0, parseInt(e.target.value) || 0))}
                                                className="input-soft patient-count-input"
                                            />
                                            <button onClick={() => setPatientCount(patientCount + 1)} className="btn-soft" style={{
                                                width: '40px', height: '40px', borderRadius: '12px',
                                                background: 'var(--pink-100)', border: 'none', cursor: 'pointer',
                                                fontSize: '18px', color: 'var(--pink-500)'
                                            }}>+</button>
                                            <span style={{ color: 'var(--warm-gray-500)' }}>ä½</span>
                                        </div>
                                    </div>

                                    {/* é–‹å§‹æ™‚é–“ */}
                                    <div>
                                        <label style={{ display: 'block', fontSize: '13px', fontWeight: 600, color: 'var(--warm-gray-600)', marginBottom: '8px' }}>
                                            é–‹å§‹æ‰“è—¥æ™‚é–“
                                        </label>
                                        <input
                                            type="time"
                                            value={config.startTime}
                                            onChange={(e) => handleConfigChange('startTime', e.target.value)}
                                            className="input-soft"
                                        />
                                    </div>

                                    {/* Early Scan */}
                                    <div>
                                        <label style={{ display: 'block', fontSize: '13px', fontWeight: 600, color: 'var(--warm-gray-600)', marginBottom: '8px' }}>
                                            Early Scan (åˆ†é˜)
                                        </label>
                                        <input
                                            type="number"
                                            value={config.earlyScanDuration}
                                            onChange={(e) => handleConfigChange('earlyScanDuration', parseInt(e.target.value) || 0)}
                                            className="input-soft"
                                            style={{ width: '80px' }}
                                        />
                                    </div>

                                    {/* Delayed Scan */}
                                    <div>
                                        <label style={{ display: 'block', fontSize: '13px', fontWeight: 600, color: 'var(--warm-gray-600)', marginBottom: '8px' }}>
                                            Delayed Scan (åˆ†é˜) <span style={{ fontSize: '11px', fontWeight: 400, color: 'var(--warm-gray-400)' }}>0=ä¸éœ€è¦</span>
                                        </label>
                                        <input
                                            type="number"
                                            min="0"
                                            value={config.delayedScanDuration}
                                            onChange={(e) => handleConfigChange('delayedScanDuration', Math.max(0, parseInt(e.target.value) || 0))}
                                            className="input-soft"
                                            style={{ width: '80px' }}
                                        />
                                    </div>

                                    {/* Uptake Time */}
                                    <div>
                                        <label style={{ display: 'block', fontSize: '13px', fontWeight: 600, color: 'var(--warm-gray-600)', marginBottom: '8px' }}>
                                            Uptake Time (åˆ†é˜)
                                        </label>
                                        <input
                                            type="number"
                                            value={config.uptakeTime}
                                            onChange={(e) => handleConfigChange('uptakeTime', parseInt(e.target.value) || 0)}
                                            className="input-soft"
                                            style={{ width: '80px' }}
                                        />
                                    </div>

                                    {/* æœ€å°ç­‰å¾…æ™‚é–“ */}
                                    <div>
                                        <label style={{ display: 'block', fontSize: '13px', fontWeight: 600, color: 'var(--warm-gray-600)', marginBottom: '8px' }}>
                                            æœ€å°ç­‰å¾… (min)
                                            <span style={{ fontSize: '10px', fontWeight: 400, color: 'var(--warm-gray-400)', marginLeft: '4px' }}>90-240</span>
                                        </label>
                                        <input
                                            type="number"
                                            min="90"
                                            max="240"
                                            value={config.minWaitLimit}
                                            onChange={(e) => handleConfigChange('minWaitLimit', e.target.value === '' ? '' : parseInt(e.target.value))}
                                            onBlur={(e) => {
                                                const val = Math.max(90, Math.min(240, parseInt(e.target.value) || 90));
                                                handleConfigChange('minWaitLimit', val);
                                            }}
                                            className="input-soft"
                                            style={{ width: '80px' }}
                                        />
                                    </div>

                                    {/* æœ€å¤§ç­‰å¾…æ™‚é–“ */}
                                    <div>
                                        <label style={{ display: 'block', fontSize: '13px', fontWeight: 600, color: 'var(--warm-gray-600)', marginBottom: '8px' }}>
                                            æœ€å¤§ç­‰å¾… (min)
                                            <span style={{ fontSize: '10px', fontWeight: 400, color: 'var(--warm-gray-400)', marginLeft: '4px' }}>90-240</span>
                                        </label>
                                        <input
                                            type="number"
                                            min="90"
                                            max="240"
                                            value={config.maxWaitLimit}
                                            onChange={(e) => handleConfigChange('maxWaitLimit', e.target.value === '' ? '' : parseInt(e.target.value))}
                                            onBlur={(e) => {
                                                const val = Math.max(90, Math.min(240, parseInt(e.target.value) || 240));
                                                handleConfigChange('maxWaitLimit', val);
                                            }}
                                            className="input-soft"
                                            style={{ width: '80px' }}
                                        />
                                    </div>
                                </div>

                                {/* åˆä¼‘æ™‚é–“è¨­å®š */}
                                <div style={{
                                    marginTop: '16px',
                                    padding: '16px',
                                    background: 'var(--warm-gray-50)',
                                    borderRadius: '12px',
                                    border: '1px solid var(--warm-gray-100)'
                                }}>
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: config.lunchBreakEnabled ? '16px' : '0' }}>
                                        <label style={{
                                            display: 'flex',
                                            alignItems: 'center',
                                            gap: '8px',
                                            cursor: 'pointer',
                                            fontSize: '14px',
                                            fontWeight: 600,
                                            color: 'var(--warm-gray-700)'
                                        }}>
                                            <input
                                                type="checkbox"
                                                checked={config.lunchBreakEnabled}
                                                onChange={(e) => handleConfigChange('lunchBreakEnabled', e.target.checked)}
                                                style={{
                                                    width: '18px',
                                                    height: '18px',
                                                    accentColor: 'var(--pink-400)'
                                                }}
                                            />
                                            ğŸ” ä¸­åˆç©ºæ©Ÿæ™‚é–“
                                        </label>
                                        <span style={{ fontSize: '12px', color: 'var(--warm-gray-500)' }}>
                                            ï¼ˆæ©Ÿå™¨ä¼‘æ¯ï¼Œä½†å¯ç¹¼çºŒæ‰“è—¥ï¼‰
                                        </span>
                                    </div>

                                    {config.lunchBreakEnabled && (
                                        <div style={{ display: 'flex', alignItems: 'center', gap: '16px', flexWrap: 'wrap' }}>
                                            <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                                <label style={{ fontSize: '13px', color: 'var(--warm-gray-600)' }}>é–‹å§‹</label>
                                                <input
                                                    type="time"
                                                    value={config.lunchBreakStart}
                                                    onChange={(e) => handleConfigChange('lunchBreakStart', e.target.value)}
                                                    className="input-soft"
                                                    style={{ width: '110px' }}
                                                />
                                            </div>
                                            <span style={{ color: 'var(--warm-gray-400)' }}>â†’</span>
                                            <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                                <label style={{ fontSize: '13px', color: 'var(--warm-gray-600)' }}>çµæŸ</label>
                                                <input
                                                    type="time"
                                                    value={config.lunchBreakEnd}
                                                    onChange={(e) => handleConfigChange('lunchBreakEnd', e.target.value)}
                                                    className="input-soft"
                                                    style={{ width: '110px' }}
                                                />
                                            </div>
                                        </div>
                                    )}
                                </div>

                                {/* Posluma PET è¨­å®š - å¯æŠ˜ç–Š */}
                                <div style={{
                                    marginTop: '16px',
                                    background: 'linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%)',
                                    borderRadius: '12px',
                                    border: '1px solid #a7f3d0',
                                    overflow: 'hidden'
                                }}>
                                    {/* å¯é»æ“Šæ¨™é¡Œ */}
                                    <div
                                        onClick={() => setPoslumaExpanded(!poslumaExpanded)}
                                        style={{
                                            padding: '14px 16px',
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'space-between',
                                            cursor: 'pointer',
                                            userSelect: 'none'
                                        }}
                                    >
                                        <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                                            <span style={{
                                                background: 'linear-gradient(135deg, #34d399 0%, #10b981 100%)',
                                                padding: '4px 12px',
                                                borderRadius: '8px',
                                                fontSize: '13px',
                                                fontWeight: 700,
                                                color: 'white'
                                            }}>Posluma</span>
                                            <span style={{ fontSize: '14px', fontWeight: 600, color: '#047857' }}>PSMA PET è¨­å®š</span>
                                            {config.poslumaCount > 0 && (
                                                <span style={{
                                                    background: '#10b981',
                                                    color: 'white',
                                                    padding: '2px 8px',
                                                    borderRadius: '10px',
                                                    fontSize: '11px',
                                                    fontWeight: 600
                                                }}>{config.poslumaCount} ä½</span>
                                            )}
                                        </div>
                                        <i className={`fa-solid fa-chevron-${poslumaExpanded ? 'up' : 'down'}`}
                                            style={{ color: '#059669', fontSize: '14px', transition: 'transform 0.2s' }}></i>
                                    </div>

                                    {/* å¯æŠ˜ç–Šå…§å®¹ */}
                                    <div style={{
                                        maxHeight: poslumaExpanded ? '500px' : '0',
                                        overflow: 'hidden',
                                        transition: 'max-height 0.3s ease-in-out',
                                        padding: poslumaExpanded ? '0 16px 16px 16px' : '0 16px'
                                    }}>
                                        <div style={{ display: 'flex', flexWrap: 'wrap', gap: '16px', alignItems: 'flex-end' }}>
                                            {/* Posluma ç—…äººæ•¸é‡ */}
                                            <div>
                                                <label style={{ display: 'block', fontSize: '12px', fontWeight: 600, color: '#047857', marginBottom: '6px' }}>
                                                    ç—…äººæ•¸é‡
                                                </label>
                                                <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                                    <button onClick={() => handleConfigChange('poslumaCount', Math.max(0, config.poslumaCount - 1))} className="btn-soft" style={{
                                                        width: '32px', height: '32px', borderRadius: '8px',
                                                        background: '#d1fae5', border: 'none', cursor: 'pointer',
                                                        fontSize: '16px', color: '#059669'
                                                    }}>âˆ’</button>
                                                    <input
                                                        type="number"
                                                        value={config.poslumaCount}
                                                        onChange={(e) => handleConfigChange('poslumaCount', Math.max(0, parseInt(e.target.value) || 0))}
                                                        className="input-soft patient-count-input"
                                                        style={{ fontSize: '20px' }}
                                                    />
                                                    <button onClick={() => handleConfigChange('poslumaCount', config.poslumaCount + 1)} className="btn-soft" style={{
                                                        width: '32px', height: '32px', borderRadius: '8px',
                                                        background: '#d1fae5', border: 'none', cursor: 'pointer',
                                                        fontSize: '16px', color: '#059669'
                                                    }}>+</button>
                                                </div>
                                            </div>

                                            {/* Posluma Early Scan */}
                                            <div>
                                                <label style={{ display: 'block', fontSize: '12px', fontWeight: 600, color: '#047857', marginBottom: '6px' }}>
                                                    Early Scan (min)
                                                </label>
                                                <input
                                                    type="number"
                                                    value={config.poslumaEarlyScan}
                                                    onChange={(e) => handleConfigChange('poslumaEarlyScan', parseInt(e.target.value) || 0)}
                                                    className="input-soft"
                                                    style={{ width: '70px' }}
                                                />
                                            </div>

                                            {/* Posluma Delayed Scan */}
                                            <div>
                                                <label style={{ display: 'block', fontSize: '12px', fontWeight: 600, color: '#047857', marginBottom: '6px' }}>
                                                    Delayed (min) <span style={{ fontSize: '10px', fontWeight: 400 }}>0=ä¸éœ€è¦</span>
                                                </label>
                                                <input
                                                    type="number"
                                                    min="0"
                                                    value={config.poslumaDelayedScan}
                                                    onChange={(e) => handleConfigChange('poslumaDelayedScan', Math.max(0, parseInt(e.target.value) || 0))}
                                                    className="input-soft"
                                                    style={{ width: '70px' }}
                                                />
                                            </div>

                                            {/* Posluma Uptake Time */}
                                            <div>
                                                <label style={{ display: 'block', fontSize: '12px', fontWeight: 600, color: '#047857', marginBottom: '6px' }}>
                                                    Uptake (min)
                                                </label>
                                                <input
                                                    type="number"
                                                    value={config.poslumaUptakeTime}
                                                    onChange={(e) => handleConfigChange('poslumaUptakeTime', parseInt(e.target.value) || 0)}
                                                    className="input-soft"
                                                    style={{ width: '70px' }}
                                                />
                                            </div>
                                        </div>

                                        {/* Posluma è‡ªè¨‚æ‰“è—¥æ™‚é–“ */}
                                        {config.poslumaCount > 0 && (
                                            <div style={{ marginTop: '16px', paddingTop: '16px', borderTop: '1px dashed #a7f3d0' }}>
                                                <label style={{ display: 'block', fontSize: '12px', fontWeight: 600, color: '#047857', marginBottom: '8px' }}>
                                                    <i className="fa-solid fa-syringe" style={{ marginRight: '6px' }}></i>
                                                    è‡ªè¨‚æ‰“è—¥æ™‚é–“ï¼ˆå¯é¸ï¼‰
                                                </label>
                                                <div style={{ display: 'flex', flexWrap: 'wrap', gap: '12px' }}>
                                                    {Array.from({ length: config.poslumaCount }, (_, i) => (
                                                        <div key={i} style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                                                            <span style={{ fontSize: '12px', color: '#059669', fontWeight: 600 }}>P{i + 1}</span>
                                                            <input
                                                                type="time"
                                                                value={config.poslumaInjectionTimes[i] || '14:00'}
                                                                onChange={(e) => {
                                                                    const newTimes = [...config.poslumaInjectionTimes];
                                                                    newTimes[i] = e.target.value;
                                                                    handleConfigChange('poslumaInjectionTimes', newTimes);
                                                                }}
                                                                className="input-soft"
                                                                style={{ width: '130px', fontSize: '14px', padding: '8px 12px' }}
                                                            />
                                                        </div>
                                                    ))}
                                                </div>
                                                <p style={{ margin: '8px 0 0 0', fontSize: '11px', color: '#6b7280' }}>
                                                    ç•™ç©º = ç³»çµ±è‡ªå‹•æ’å…¥æœ€ä½³ç©ºéš™
                                                </p>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>

                            {/* æ¨¡å¼ç‹€æ…‹ */}
                            {(patientCount > 0 || config.poslumaCount > 0) && (
                                <div style={{
                                    padding: '14px 24px',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'space-between',
                                    flexWrap: 'wrap',
                                    gap: '12px',
                                    borderTop: '1px solid var(--warm-gray-100)',
                                    background: result.mode === 'BATCH'
                                        ? 'linear-gradient(90deg, #dcfce7 0%, #bbf7d0 100%)'
                                        : result.mode === 'AUTO_INTERLEAVED'
                                            ? 'linear-gradient(90deg, #dbeafe 0%, #bfdbfe 100%)'
                                            : result.mode === 'EARLY_ONLY'
                                                ? 'linear-gradient(90deg, #fef3c7 0%, #fde68a 100%)'
                                                : result.mode === 'MIXED'
                                                    ? 'linear-gradient(90deg, #d1fae5 0%, #a7f3d0 100%)'
                                                    : result.mode === 'POSLUMA_ONLY'
                                                        ? 'linear-gradient(90deg, #ecfdf5 0%, #d1fae5 100%)'
                                                        : result.mode === 'ERROR'
                                                            ? 'linear-gradient(90deg, #fee2e2 0%, #fecaca 100%)'
                                                            : 'var(--warm-gray-50)'
                                }}>
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '10px', flexWrap: 'wrap' }}>
                                        {result.mode === 'BATCH' && (
                                            <>
                                                <i className="fa-solid fa-check-circle" style={{ fontSize: '20px', color: '#166534' }}></i>
                                                <span style={{ fontWeight: 700, color: '#166534' }}>æ‰¹æ¬¡æ¨¡å¼</span>
                                                <span style={{ fontSize: '13px', color: '#15803d' }}>ä¾åºå®Œæˆæ‰€æœ‰ Early å¾Œå†åš Delayed</span>
                                            </>
                                        )}
                                        {result.mode === 'AUTO_INTERLEAVED' && (
                                            <>
                                                <i className="fa-solid fa-arrows-rotate" style={{ fontSize: '20px', color: '#1e40af' }}></i>
                                                <span style={{ fontWeight: 700, color: '#1e40af' }}>è‡ªå‹•å„ªåŒ–æ’ç¨‹</span>
                                                <span style={{ fontSize: '13px', color: '#1d4ed8' }}>
                                                    {result.summary}
                                                </span>
                                            </>
                                        )}
                                        {result.mode === 'EARLY_ONLY' && (
                                            <>
                                                <i className="fa-solid fa-bolt" style={{ fontSize: '20px', color: '#92400e' }}></i>
                                                <span style={{ fontWeight: 700, color: '#92400e' }}>åƒ… Early Scan</span>
                                                <span style={{ fontSize: '13px', color: '#a16207' }}>ç—…äººä¸éœ€è¦ Delayed Scan</span>
                                            </>
                                        )}
                                        {result.mode === 'MIXED' && (
                                            <>
                                                <i className="fa-solid fa-layer-group" style={{ fontSize: '20px', color: '#047857' }}></i>
                                                <span style={{ fontWeight: 700, color: '#047857' }}>æ··åˆæ’ç¨‹</span>
                                                <span style={{ fontSize: '13px', color: '#059669' }}>
                                                    {result.summary}
                                                </span>
                                            </>
                                        )}
                                        {result.mode === 'POSLUMA_ONLY' && (
                                            <>
                                                <i className="fa-solid fa-dna" style={{ fontSize: '20px', color: '#059669' }}></i>
                                                <span style={{ fontWeight: 700, color: '#059669' }}>Posluma æ’ç¨‹</span>
                                                <span style={{ fontSize: '13px', color: '#10b981' }}>
                                                    {result.summary}
                                                </span>
                                            </>
                                        )}
                                        {result.mode === 'ERROR' && (
                                            <>
                                                <i className="fa-solid fa-circle-xmark" style={{ fontSize: '20px', color: '#dc2626' }}></i>
                                                <span style={{ fontWeight: 700, color: '#dc2626' }}>åƒæ•¸éŒ¯èª¤</span>
                                                <span style={{ fontSize: '13px', color: '#b91c1c' }}>{result.error}</span>
                                            </>
                                        )}
                                    </div>

                                    <div style={{ display: 'flex', alignItems: 'center', gap: '16px', fontSize: '13px', flexWrap: 'wrap' }}>
                                        {result.maxPatientWaitTime && (
                                            <div style={{ color: 'var(--warm-gray-600)' }}>
                                                æœ€é•·ç­‰å¾…ï¼š
                                                <span style={{ fontWeight: 700, marginLeft: '4px', color: '#16a34a' }}>
                                                    {Math.floor(result.maxPatientWaitTime / 60)}h {result.maxPatientWaitTime % 60}m
                                                </span>
                                            </div>
                                        )}
                                        {result.machineIdleTime !== undefined && (
                                            <div style={{ color: 'var(--warm-gray-600)' }}>
                                                ç©ºæ©Ÿæ™‚é–“ï¼š
                                                <span style={{ fontWeight: 700, marginLeft: '4px', color: result.machineIdleTime > 0 ? '#ea580c' : '#16a34a' }}>
                                                    {result.machineIdleTime} min
                                                </span>
                                            </div>
                                        )}
                                        {result.batches && result.batches.length > 1 && (
                                            <div style={{ color: 'var(--warm-gray-600)' }}>
                                                FDG åˆ† <span style={{ fontWeight: 700, color: '#1d4ed8' }}>{result.batches.length}</span> æ‰¹
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}

                            {/* Posluma æ™‚é–“è¡çªè­¦å‘Š */}
                            {result.poslumaWarnings && result.poslumaWarnings.length > 0 && (
                                <div style={{
                                    padding: '14px 24px',
                                    background: 'linear-gradient(90deg, #fef3c7 0%, #fde68a 100%)',
                                    borderTop: '1px solid #fbbf24'
                                }}>
                                    <div style={{ display: 'flex', alignItems: 'flex-start', gap: '10px' }}>
                                        <i className="fa-solid fa-triangle-exclamation" style={{ fontSize: '18px', color: '#b45309', marginTop: '2px' }}></i>
                                        <div style={{ flex: 1 }}>
                                            <div style={{ fontWeight: 700, color: '#92400e', marginBottom: '10px' }}>Posluma æ™‚é–“è¡çªå»ºè­°</div>
                                            {result.poslumaWarnings.map((w, idx) => (
                                                <div key={idx} style={{
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    justifyContent: 'space-between',
                                                    gap: '12px',
                                                    padding: '8px 12px',
                                                    background: 'rgba(255,255,255,0.6)',
                                                    borderRadius: '8px',
                                                    marginBottom: '6px',
                                                    flexWrap: 'wrap'
                                                }}>
                                                    <div style={{ fontSize: '13px', color: '#a16207' }}>
                                                        <strong>{w.patientId}</strong>: è¨­å®š {w.originalTime} èˆ‡å…¶ä»–æª¢æŸ¥è¡çª
                                                    </div>
                                                    <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                                        <span style={{ fontSize: '12px', color: '#6b7280' }}>å»ºè­°</span>
                                                        <span style={{
                                                            padding: '4px 10px',
                                                            background: '#bbf7d0',
                                                            borderRadius: '6px',
                                                            fontSize: '13px',
                                                            color: '#16a34a',
                                                            fontWeight: 600
                                                        }}>{w.suggestedTime}</span>
                                                        <button
                                                            onClick={() => {
                                                                const newTimes = [...config.poslumaInjectionTimes];
                                                                newTimes[w.patientIndex] = w.suggestedValue;
                                                                handleConfigChange('poslumaInjectionTimes', newTimes);
                                                            }}
                                                            className="btn-soft"
                                                            style={{
                                                                background: 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)',
                                                                color: 'white',
                                                                border: 'none',
                                                                padding: '5px 10px',
                                                                borderRadius: '6px',
                                                                fontSize: '12px',
                                                                fontWeight: 600,
                                                                cursor: 'pointer'
                                                            }}
                                                        >
                                                            <i className="fa-solid fa-check" style={{ marginRight: '4px' }}></i>
                                                            æ¡ç”¨
                                                        </button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* Tab åˆ‡æ› */}
                        <div className="no-print" style={{ display: 'flex', gap: '10px', marginBottom: '24px' }}>
                            <button
                                onClick={() => setActiveTab('planner')}
                                className="btn-soft"
                                style={{
                                    display: 'flex', alignItems: 'center', gap: '8px',
                                    padding: '12px 24px', borderRadius: '14px', border: 'none',
                                    cursor: 'pointer', fontSize: '14px', fontWeight: 600,
                                    background: activeTab === 'planner'
                                        ? 'linear-gradient(135deg, #e9d5ff 0%, #f5d0fe 100%)'
                                        : 'white',
                                    color: activeTab === 'planner' ? '#7c3aed' : 'var(--warm-gray-600)',
                                    boxShadow: activeTab === 'planner' ? '0 4px 14px rgba(124, 58, 237, 0.15)' : '0 2px 8px rgba(0,0,0,0.04)'
                                }}
                            >
                                <i className="fa-solid fa-clipboard-list" style={{ marginRight: '6px' }}></i> é†«å¸«è¦åŠƒ
                            </button>
                            <button
                                onClick={() => setActiveTab('worklist')}
                                className="btn-soft"
                                style={{
                                    display: 'flex', alignItems: 'center', gap: '8px',
                                    padding: '12px 24px', borderRadius: '14px', border: 'none',
                                    cursor: 'pointer', fontSize: '14px', fontWeight: 600,
                                    background: activeTab === 'worklist'
                                        ? 'linear-gradient(135deg, #bbf7d0 0%, #86efac 100%)'
                                        : 'white',
                                    color: activeTab === 'worklist' ? '#166534' : 'var(--warm-gray-600)',
                                    boxShadow: activeTab === 'worklist' ? '0 4px 14px rgba(22, 101, 52, 0.15)' : '0 2px 8px rgba(0,0,0,0.04)'
                                }}
                            >
                                <i className="fa-solid fa-list-check" style={{ marginRight: '6px' }}></i> æ”¾å°„å¸«æ¸…å–®
                            </button>
                        </div>

                        {/* Tab å…§å®¹ */}
                        {
                            activeTab === 'planner' ? (
                                <PlannerTab schedule={result.schedule} result={result} config={config} />
                            ) : (
                                <WorklistTab schedule={result.schedule} result={result} />
                            )
                        }
                    </main >

                    {/* é è…³ */}
                    < footer className="no-print" style={{
                        marginTop: '48px',
                        padding: '20px',
                        textAlign: 'center',
                        fontSize: '13px',
                        color: 'var(--warm-gray-400)'
                    }}>
                        <i className="fa-regular fa-star" style={{ marginRight: '6px' }}></i> PET æ™ºæ…§æ’ç¨‹åŠ©æ‰‹ v2.0 | åƒ…ä¾›åƒè€ƒï¼Œå¯¦éš›æ“ä½œè«‹ä¾è‡¨åºŠåˆ¤æ–·
                    </footer >
                </div >
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>